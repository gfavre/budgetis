{% load money i18n %}

<div id="account-list">
  {% if last_import_text %}
    <p class="text-muted small mb-3 no-print">
      <i class="bi bi-clock-history"></i>
      {{ last_import_text }}
    </p>
  {% endif %}
  {% for mg_code, mg in grouped.items %}
    <h2>{{ mg_code }} {{ mg.label }}</h2>
    <!-- Tableau récapitulatif du supergroupe -->
    <table class="table table-bordered align-middle mb-5 mt-5">
      <colgroup span="2" class="info">
        <col span="1" class="col-num" />
        <col span="1" class="col-label" />
      </colgroup>          <!-- N°, Désignation -->
      <colgroup span="2" class="budget-current">
        <col span="1" class="col-charges" />
        <col span="1" class="col-revenues" />
      </colgroup> <!-- Budget courant -->
      <colgroup span="2" class="budget-prev">
        <col span="1" class="col-charges" />
        <col span="1" class="col-revenues" />
      </colgroup>    <!-- Budget -1 -->
      <colgroup span="2" class="accounts-prev">
        <col span="1" class="col-charges" />
        <col span="1" class="col-revenues" />
      </colgroup>  <!-- Comptes -2 -->
      <thead>
        <tr class="table-light text-center">
          <th rowspan="2" class="text-start">N°</th>
          <th rowspan="2" class="text-start">Désignation</th>
          <th colspan="2" class="text-center">Budget {{ year }}</th>
          <th colspan="2" class="text-center">Budget {{ previous_year }}</th>
          <th colspan="2" class="text-center">Comptes {{ actuals_year }}</th>
        </tr>
        <tr class="table-light text-center">
          <th>Charges</th>
          <th>Produits</th>
          <th>Charges</th>
          <th>Produits</th>
          <th>Charges</th>
          <th>Produits</th>
        </tr>
      </thead>
      <thead class="table-primary fw-bold">
        <tr>
          <td>{{ mg_code }}</td>
          <td>Total {{ mg.label }}</td>
          <td class="text-end">{{ mg.budget_total_charges|format_money }}</td>
          <td class="text-end">{{ mg.budget_total_revenues|format_money }}</td>
          <td class="text-end">{{ mg.prev_budget_total_charges|format_money }}</td>
          <td class="text-end">{{ mg.prev_budget_total_revenues|format_money }}</td>
          <td class="text-end">{{ mg.actual_total_charges|format_money }}</td>
          <td class="text-end">{{ mg.actual_total_revenues|format_money }}</td>
        </tr>
      </thead>
      <tbody>
        {% for sg_code, sg in mg.supergroups.items %}
          <tr>
            <td class="text-nowrap">{{ sg_code }}</td>
            <td>{{ sg.label }}</td>
            <td class="text-end">{{ sg.budget_total_charges|format_money }}</td>
            <td class="text-end">{{ sg.budget_total_revenues|format_money }}</td>
            <td class="text-end">{{ sg.prev_budget_total_charges|format_money }}</td>
            <td class="text-end">{{ sg.prev_budget_total_revenues|format_money }}</td>
            <td class="text-end">{{ sg.actual_total_charges|format_money }}</td>
            <td class="text-end">{{ sg.actual_total_revenues|format_money }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    {% for sg_code, sg in mg.supergroups.items %}
      <h3>{{ sg_code }} {{ sg.label }}</h3>
      {% for ag_code, ag in sg.groups.items %}
        {% include "accounting/partials/budget_group_block.html" with code=ag_code label=ag.label data=ag %}
      {% endfor %}
    {% endfor %}
  {% endfor %}
</div>
<hr class="section-sep page-break-before" />
<h1 class="metagroup">{% trans "Operating account" %}</h1>
<table class="table table-bordered recap global-summary">
  <colgroup span="2" class="info">
    <col span="1" class="col-num" />
    <col span="1" class="col-label" />
  </colgroup>          <!-- N°, Désignation -->
  <colgroup span="2" class="budget-current">
    <col span="1" class="col-charges" />
    <col span="1" class="col-revenues" />
  </colgroup> <!-- Budget courant -->
  <colgroup span="2" class="budget-prev">
    <col span="1" class="col-charges" />
    <col span="1" class="col-revenues" />
  </colgroup>    <!-- Budget -1 -->
  <colgroup span="2" class="accounts-prev">
    <col span="1" class="col-charges" />
    <col span="1" class="col-revenues" />
  </colgroup>  <!-- Comptes -2 -->
  <thead>
    <tr class="table-light text-center">
      <th rowspan="2" class="text-start">N°</th>
      <th rowspan="2" class="text-start">Désignation</th>
      <th colspan="2" class="text-center">Budget {{ year }}</th>
      <th colspan="2" class="text-center">Budget {{ previous_year }}</th>
      <th colspan="2" class="text-center">Comptes {{ actuals_year }}</th>
    </tr>
    <tr class="table-light text-center">
      <th>Charges</th>
      <th>Produits</th>
      <th>Charges</th>
      <th>Produits</th>
      <th>Charges</th>
      <th>Produits</th>
    </tr>
  </thead>
  <tbody>
    {% for row in global_summary.rows %}
      <tr>
        <td>{{ row.code }}</td>
        <td>{{ row.label }}</td>
        <td class="text-end">{{ row.budget_total_charges|format_money }}</td>
        <td class="text-end">{{ row.budget_total_revenues|format_money }}</td>
        <td class="text-end">{{ row.prev_budget_total_charges|format_money }}</td>
        <td class="text-end">{{ row.prev_budget_total_revenues|format_money }}</td>
        <td class="text-end">{{ row.actual_total_charges|format_money }}</td>
        <td class="text-end">{{ row.actual_total_revenues|format_money }}</td>
      </tr>
    {% endfor %}
  </tbody>
  <tfoot class="table-primary fw-bold">
    <tr>
      <td colspan="2"></td>
      <td class="text-end">{{ global_summary.totals.budget_total_charges|format_money }}</td>
      <td class="text-end">{{ global_summary.totals.budget_total_revenues|format_money }}</td>
      <td class="text-end">{{ global_summary.totals.prev_budget_total_charges|format_money }}</td>
      <td class="text-end">{{ global_summary.totals.prev_budget_total_revenues|format_money }}</td>
      <td class="text-end">{{ global_summary.totals.actual_total_charges|format_money }}</td>
      <td class="text-end">{{ global_summary.totals.actual_total_revenues|format_money }}</td>
    </tr>
    <tr>
      <td colspan="2" class="text-right">{% trans "Revenue suprlus" %}</td>
      <td>
        {% if global_summary.totals.budget_diff > 0 %}{{ global_summary.totals.budget_diff|format_money_abs }}{% endif %}
      </td>
      <td></td>
      <td>
        {% if global_summary.totals.budget_prev_diff > 0 %}{{ totals.budget_prev_diff|format_money_abs }}{% endif %}
      </td>
      <td></td>
      <td>
        {% if global_summary.totals.actual_diff > 0 %}{{ global_summary.totals.actual_diff|format_money_abs }}{% endif %}
      </td>
      <td></td>
    </tr>
    <tr>
      <td colspan="2" class="text-right">{% trans "Excess expense" %}</td>
      <td></td>
      <td>
        {% if global_summary.totals.budget_diff < 0 %}{{ global_summary.totals.budget_diff|format_money_abs }}{% endif %}
      </td>
      <td></td>
      <td>
        {% if global_summary.totals.budget_prev_diff < 0 %}
          {{ global_summary.totals.budget_prev_diff|format_money_abs }}
        {% endif %}
      </td>
      <td></td>
      <td>
        {% if global_summary.totals.actual_diff < 0 %}{{ global_summary.totals.actual_diff|format_money_abs }}{% endif %}
      </td>
    </tr>
    <tr>
      <th colspan="2"></th>
      <th>{{ global_summary.totals.balanced_budget|format_money_abs }}</th>
      <th>{{ global_summary.totals.balanced_budget|format_money_abs }}</th>
      <th>{{ global_summary.totals.balanced_prev_budget|format_money_abs }}</th>
      <th>{{ global_summary.totals.balanced_prev_budget|format_money_abs }}</th>
      <th>{{ global_summary.totals.balanced_actual|format_money_abs }}</th>
      <th>{{ global_summary.totals.balanced_actual|format_money_abs }}</th>
    </tr>
  </tfoot>
</table>
<div class="modal fade"
     id="accountHistoryModal"
     tabindex="-1"
     aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <!-- HTMX va remplacer ce contenu -->
    </div>
  </div>
</div>
{% include "accounting/partials/comments_modal.html" %}
