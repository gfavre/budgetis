<div class="modal-header">
  <h5 class="modal-title">Historique {{ account.full_code }} – {{ account.label }}</h5>
  <button type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Fermer"></button>
</div>
<div class="modal-body">
  <canvas id="accountHistoryChart" class="chart-canvas w-100"></canvas>
</div>
<script>
  (() => {
    const ctx = document.getElementById("accountHistoryChart");
    const commentsByYear = {{ comments_by_year|safe }};

    new Chart(ctx, {
      type: "line",
      data: {
        labels: {{ years|safe }},
        datasets: [
          {
            label: "Comptes",
            data: {{ comptes|safe }},
            borderColor: "#0d6efd",
            backgroundColor: "rgba(13,110,253,0.15)",
            tension: 0.2,
            fill: true,
            borderWidth: 2,
            pointRadius: 3,
            pointHoverRadius: 5,
          },
          {
            label: "Budget",
            data: {{ budgets|safe }},
            borderColor: "#6c757d",
            backgroundColor: "rgba(108,117,125,0.1)",
            tension: 0.2,
            fill: true,
            borderWidth: 2,
            pointRadius: 3,
            pointHoverRadius: 5,
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,  // <-- souvent nécessaire dans un modal
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
          let year = context.label;
          let datasetLabel = context.dataset.label.toLowerCase(); // "comptes" ou "budget"
          let lines = [
            `${context.dataset.label}: ${context.parsed.y.toLocaleString()} CHF`
          ];

          // Ajouter les commentaires
          if (commentsByYear[year] && commentsByYear[year][datasetLabel]) {
            lines.push("Commentaires:");   // titre
            commentsByYear[year][datasetLabel].forEach(c => {
              lines.push(`- ${c}`);       // chaque commentaire sur sa ligne
            });
          }
          return lines; // ✅ tableau → chaque élément = nouvelle ligne
        }
      }


          },
          legend: {
            position: "bottom",
            labels: {
              usePointStyle: true,
              padding: 20
            }
          },
          title: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function (value) {
                return value.toLocaleString() + " CHF";
              }
            }
          }
        }
      }
    });

    // Fix for Bootstrap modal resize issue
    document.addEventListener("shown.bs.modal", function (event) {
      if (event.target.querySelector("#accountHistoryChart")) {
        chart.resize();
      }
    });
  })();
</script>
