{% load money %}

<table class="table table-bordered align-middle mb-0">
  <thead>
    <!-- Ligne d'en-tête colonnes -->
    <tr class="table-light text-center">
      <th rowspan="2" class="text-start">N°</th>
      <th rowspan="2" class="text-start">Désignation</th>
      <th colspan="2">Comptes {{ year }}</th>
      <th colspan="2">Budget {{ year }}</th>
    </tr>
    <tr class="table-light text-center">
      <th>Charges</th>
      <th>Produits</th>
      <th>Charges</th>
      <th>Produits</th>
    </tr>
  </thead>
  <tbody>
    {% for account in accounts %}
      <tr>
        <td class="text-nowrap">{{ account.full_code }}</td>
        <td>
          <a href="{% url 'accounting:account-history' account.id %}"
             class="account-history-link"
             hx-get="{% url 'accounting:account-history' account.id %}"
             hx-target="#accountHistoryModal .modal-content"
             hx-trigger="click"
             hx-swap="innerHTML"
             data-bs-toggle="modal"
             data-bs-target="#accountHistoryModal">{{ account.label }}</a>
        </td>
        <td class="text-end">
          {{ account.charges|format_money }}
          {% with diff=account.charges|percent_diff:account.budget_charges %}
            {% if diff != "" %}
              <small class="{% if diff > 0 %}text-danger{% elif diff < 0 %}text-success{% endif %}">
                (
                {% if diff > 0 %}+{% endif %}
                {{ diff }}&nbsp;%)
              </small>
            {% endif %}
          {% endwith %}
        </td>
        <td class="text-end">
          {{ account.revenues|format_money }}
          {% with diff=account.revenues|percent_diff:account.budget_revenues %}
            {% if diff != "" %}
              <small class="{% if diff > 0 %}text-success{% elif diff < 0 %}text-danger{% endif %}">
                (
                {% if diff > 0 %}+{% endif %}
                {{ diff }}&nbsp;%)
              </small>
            {% endif %}
          {% endwith %}
        </td>
        <td class="text-end">{{ account.budget_charges|format_money }}</td>
        <td class="text-end">{{ account.budget_revenues|format_money }}</td>
      </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <!-- Ligne d'en-tête style "190 Service informatique" avec totaux -->
    <tr class="table-secondary fw-bold">
      <td colspan="2">{{ code }} {{ label }}</td>
      <td class="text-end">
        {{ data.total_charges|format_money }}
        {% with diff=data.total_charges|percent_diff:data.budget_total_charges %}
          {% if diff != "" %}
            <small class="{% if diff > 0 %}text-danger{% elif diff < 0 %}text-success{% endif %}">
              (
              {% if diff > 0 %}+{% endif %}
              {{ diff }}&nbsp;%)
            </small>
          {% endif %}
        {% endwith %}
      </td>
      <td class="text-end">
        {{ data.total_revenues|format_money }}
        {% with diff=data.total_revenues|percent_diff:data.budget_total_revenues %}
          {% if diff != "" %}
            <small class="{% if diff > 0 %}text-success{% elif diff < 0 %}text-danger{% endif %}">
              (
              {% if diff > 0 %}+{% endif %}
              {{ diff }}&nbsp;%)
            </small>
          {% endif %}
        {% endwith %}
      </td>
      <td class="text-end">{{ data.budget_total_charges|format_money }}</td>
      <td class="text-end">{{ data.budget_total_revenues|format_money }}</td>
    </tr>
  </tfoot>
</table>
